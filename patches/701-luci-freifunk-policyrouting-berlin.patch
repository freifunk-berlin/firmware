Index: openwrt/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/config/freifunk-policyrouting
===================================================================
--- openwrt.orig/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/config/freifunk-policyrouting
+++ openwrt/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/config/freifunk-policyrouting
@@ -1,7 +1,5 @@
-
 config 'settings' 'pr'
 	option 'enable' '0'
 	option 'strict' '1'
-        option 'fallback' '1'
-	option 'zones' ''
-
+	option 'fallback' '0'
+	option 'zones' 'freifunk'
Index: openwrt/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/hotplug.d/iface/30-policyrouting
===================================================================
--- openwrt.orig/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/hotplug.d/iface/30-policyrouting
+++ openwrt/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/hotplug.d/iface/30-policyrouting
@@ -4,7 +4,7 @@
 . /lib/functions/network.sh
 
 proto="4"
-[ -f /proc/net/ipv6_route ] && proto="4 6"
+#[ -f /proc/net/ipv6_route ] && proto="4 6"
 
 config_load freifunk-policyrouting
 config_get enable pr enable
@@ -13,33 +13,26 @@ config_get strict pr strict
 config_get zones pr zones
 
 if [ "$ACTION" = "ifup" ] && [ "$enable" = "1" ]; then
-	network_get_subnet net $INTERFACE
-	network_get_subnet6 net6 $INTERFACE
-	network_get_physdev dev $INTERFACE
+	case $(uci get network.${INTERFACE}.proto) in none)
+		# ubus status/netifd does not output ip4addr if proto=none
+		net=$(ip -4 addr show dev ${DEVICE} scope global|sed -n '2s,^[[:space:]]\+inet \([^[:space:]]\+\).*,\1,p')
+		#net6=$(ip -6 addr show dev ${DEVICE} scope global|sed -n '2s,^[[:space:]]\+inet6 \([^[:space:]]\+\).*,\1,p')
+	;;*)
+		network_get_subnet net $INTERFACE
+		#network_get_subnet6 net6 $INTERFACE
+	;;esac
 
-	if [ "$net" != "" -a -n "$dev" ]; then
+	if [ "$net" != "" -a -n "${DEVICE}" ]; then
 		eval $(/bin/ipcalc.sh $net)
-		if [ "$PREFIX" != "0" -a "$NETWORK" != "127.0.0.0" ]; then
-			if [ ! "$(ip r s t localnets |grep "$NETWORK/$PREFIX dev")" ]; then
-				cmd="ip r a $NETWORK/$PREFIX dev $dev table localnets"
-				$cmd
-				if [ "$?" = 0 ]; then
-					logger -s -t policyrouting "Add route: $cmd"
-				else
-					logger -s -t policyrouting "Error! Could not add route: $cmd"
-				fi
-			fi
-
-		fi
 
-		if [ -n "$net6" ]; then
-			cmd="ip -6 r a $net6 dev $dev table localnets"
-			$cmd 2>&1 > /dev/null
-			if [ "$?" = 0 ]; then
-				logger -s -t policyrouting "Add route: $cmd (IPv6)"
-			fi
+		#if [ -n "$net6" ]; then
+		#	cmd="ip -6 route add $net6 dev ${DEVICE} table localnets"
+		#	$cmd 2>&1 > /dev/null
+		#	if [ "$?" = 0 ]; then
+		#		logger -s -t policyrouting "Add route: $cmd (IPv6)"
+		#	fi
 
-		fi
+		#fi
 
 		networks=""
 		for z in $zones; do
@@ -50,53 +43,55 @@ if [ "$ACTION" = "ifup" ] && [ "$enable"
 			networks="$networks $network_zone"
 		done
 		for n in $networks; do
+      # Check if interface is part of one of the freifunk zones. We only want to
+      # add routes from interfaces that are part of the freifunk network.
 			if [ "$INTERFACE" = "$n" ]; then
+        # do not add default route and loopback network to localnets table
+        if [ "$PREFIX" != "0" -a "$NETWORK" != "127.0.0.0" ]; then
+          if [ ! "$(ip route show table localnets |grep "$NETWORK/$PREFIX dev")" ]; then
+            cmd="ip route add $NETWORK/$PREFIX dev ${DEVICE} table localnets"
+            $cmd
+            if [ "$?" = 0 ]; then
+              logger -s -t policyrouting "Add route: $cmd"
+            else
+              logger -s -t policyrouting "Error! Could not add route: $cmd"
+            fi
+          fi
+          if [ ! "$(ip route show table olsr |grep "$NETWORK/$PREFIX dev")" ]; then
+            cmd="ip route add $NETWORK/$PREFIX dev ${DEVICE} table olsr"
+            $cmd
+            if [ "$?" = 0 ]; then
+              logger -s -t policyrouting "Add route: $cmd"
+            else
+              logger -s -t policyrouting "Error! Could not add route: $cmd"
+            fi
+          fi
+        fi
+
 				for p in $proto; do
-					if [ ! "$(ip -$p ru s | grep "from all iif $dev lookup olsr-default")" ]; then
-						ip -$p rule add dev "$dev" lookup olsr-default prio 20000
-						if [ "$strict" != 0 ]; then
-							ip -$p rule add dev "$dev" unreachable prio 20001
-						fi
-						if [ "$?" = 0 ]; then
-							logger -s -t policyrouting "Use mesh gateway for interface $dev (IPv$p)"
-							if [ -z "$(uci -P /var/state get freifunk-policyrouting.${INTERFACE})" ]; then
-								uci -P /var/state set freifunk-policyrouting.${INTERFACE}="state"
-							fi
-							uci -P /var/state set freifunk-policyrouting.${INTERFACE}.device="$dev"
-						else
-							logger -s -t policyrouting "Error: Could not add rule: dev "$dev" lookup olsr-default prio 20000 (IPv$p)"
-						fi
+					logger -s -t policyrouting "Use mesh gateway for interface ${DEVICE} (IPv$p)"
+
+					# add olsr-tunnel rule (SmartGateway tunnel) if not present
+					if [ ! "$(ip -$p rule show | egrep "from all iif ${DEVICE} (\[detached\] )?lookup olsr-tunnel")" ]; then
+						ip -$p rule add dev "${DEVICE}" lookup olsr-tunnel prio 19999
 					fi
-				done
-			fi
-		done
-	fi
 
-fi
+					# add olsr-default rule (Default route from mesh) if not present
+					if [ ! "$(ip -$p rule show | egrep "from all iif ${DEVICE} (\[detached\] )?lookup olsr-default")" ]; then
+						ip -$p rule add dev "${DEVICE}" lookup olsr-default prio 20000
+					fi
 
-if [ "$ACTION" = "ifdown" ]; then
-	dev="$(uci -q -P /var/state get freifunk-policyrouting.${INTERFACE}.device)"
-	if [ -n "$dev" ]; then
-		networks=""
-		for z in $zones; do
-			network_zone="$(uci -q get firewall.zone_${z}.network)"
-			if [ -z "$network_zone" ]; then
-				network_zone="$z"
-			fi
-			networks="$networks $network_zone"
-		done
-		for n in $networks; do
-			if [ "$INTERFACE" = "$n" ]; then
-				for p in $proto; do
-					if [ "$(ip -$p ru s | grep "from all iif $dev lookup olsr-default")" ]; then
-						ip -$p rule del dev "$dev" lookup olsr-default prio 20000
-						ip -$p rule del dev "$dev" unreachable prio 20001
-						if [ "$?" = 0 ]; then
-							logger -s -t policyrouting "Remove rule: dev "$dev" lookup olsr-default prio 20000 (IPv$p)"
-						else
-							logger -s -t policyrouting "Error! Could not remove rule: dev "$dev" lookup olsr-default prio 20000 (IPv$p)"
-						fi
+					# add unreachable rules (prevents using router's default route (without VPN))
+					if [ "$strict" != 0 ] && [ ! "$(ip -$p rule show | egrep "from all iif ${DEVICE} (\[detached\] )?unreachable")" ]; then
+						ip -$p rule add dev "${DEVICE}" unreachable prio 20001
 					fi
+
+					# uci stuff
+					if [ -z "$(uci -P /var/state get freifunk-policyrouting.${INTERFACE})" ]; then
+						uci -P /var/state set freifunk-policyrouting.${INTERFACE}="state"
+					fi
+					uci -P /var/state set freifunk-policyrouting.${INTERFACE}.device="${DEVICE}"
+
 				done
 			fi
 		done
Index: openwrt/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/init.d/freifunk-policyrouting
===================================================================
--- openwrt.orig/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/init.d/freifunk-policyrouting
+++ openwrt/feeds/luci/contrib/package/freifunk-policyrouting/files/etc/init.d/freifunk-policyrouting
@@ -5,7 +5,7 @@ START=15
 . /lib/functions.sh
 
 proto="4"
-[ -f /proc/net/ipv6_route ] && proto="4 6"
+#[ -f /proc/net/ipv6_route ] && proto="4 6"
 [ -f /etc/config/olsrd ] && cfgs="olsrd"
 [ -f /etc/config/olsrd6 ] && cfgs="$cfgs olsrd6"
 
@@ -103,6 +103,8 @@ add_lookup_rule() {
 	name=${1/-/_}
 	lookup=$2
 	prio=$3
+	in=$4
+	name=$name"_"${in:-allif}"_"
 
 	if [ -z "$name" -o -z "$lookup" -o -z "$prio" ]; then
 		logger -s -t policyrouting "Missing parameters for add_rule!"
@@ -113,21 +115,57 @@ add_lookup_rule() {
 			else
 				rule="rule"
 			fi
+			if [ "$(uci -q get network.${name}ipv${p})" != "$rule" ] ; then
+				uci batch <<- EOF
+					set network.${name}ipv${p}="$rule"
+					set network.${name}ipv${p}.lookup="$lookup"
+					set network.${name}ipv${p}.priority="$prio"
+					set network.${name}ipv${p}.in="$in"
+				EOF
+				uci commit network
+			fi
+		done
+	fi
+}
 
-			uci batch <<- EOF
-				set network.${name}ipv${p}="$rule"
-				set network.${name}ipv${p}.lookup="$lookup"
-				set network.${name}ipv${p}.priority="$prio"
-			EOF
+add_action_rule() {
+	name=${1/-/_}
+	action=$2
+	prio=$3
+	in=$4
+	name=$name"_"${in:-allif}"_"
+
+	if [ -z "$name" -o -z "$action" -o -z "$prio" ]; then
+		logger -s -t policyrouting "Missing parameters for add_action!"
+	else
+		for p in $proto; do
+			if [ "$p" = "6" ]; then
+				rule="rule6"
+			else
+				rule="rule"
+			fi
+			if [ "$(uci -q get network.${name}ipv${p})" != "$rule" ] ; then
+				uci batch <<- EOF
+					set network.${name}ipv${p}="$rule"
+					set network.${name}ipv${p}.action="$action"
+					set network.${name}ipv${p}.priority="$prio"
+					set network.${name}ipv${p}.in="$in"
+				EOF
+				uci commit network
+			fi
 		done
 	fi
 }
 
-del_lookup_rule() {
+
+del_rule() {
 	name=${1/-/_}
+	in=$2
+	name=$name"_"${in:-allif}"_"
 	for p in $proto; do
 		uci -q delete network.${name}ipv${p}
 	done
+	uci commit network
 }
 
 start() {
@@ -135,7 +173,7 @@ start() {
 		logger -s -t policyrouting "Starting policy routing."
 		rt_tables
 		olsrd_intalltables
-		disable_dyngw
+		#disable_dyngw
 
 		add_lookup_rule olsr olsr 1000
 		add_lookup_rule localnets localnets 2000
@@ -143,6 +181,26 @@ start() {
 		if [ "$fallback" = 1 ]; then
 			add_lookup_rule olsr-default olsr-default 100000
 		fi
+		networks=""
+		for z in $zones; do
+			network_zone="$(uci -q get firewall.zone_${z}.network)"
+			if [ -z "$network_zone" ]; then
+				network_zone="$z"
+			fi
+			networks="$networks $network_zone"
+		done
+
+		sgw="$(uci -q get olsrd.@olsrd[0].SmartGateway)"
+		for n in $networks; do
+			# only add route for tunnel if smart gateway is enabled
+			if [ "$sgw" = "yes" ]; then
+				add_lookup_rule olsr-tunnel olsr-tunnel 19999 $n
+			fi
+			add_lookup_rule olsr-default olsr-default 20000 $n
+			if [ "$strict" != 0 ]; then
+				add_action_rule olsr-default_unreachable unreachable 20001 $n
+			fi
+		done
 	fi
 	uci commit network
 	if [ ! "$1" = "noservicerestart" ]; then
@@ -153,20 +211,33 @@ start() {
 stop() {
 	logger -s -t policyrouting "Stopping policy routing"
 	olsrd_rmtables
-	del_lookup_rule olsr-default
-	del_lookup_rule olsr
-	del_lookup_rule localnets
-	uci commit network
+	del_rule olsr-default
+	del_rule olsr
+	del_rule localnets
+	networks=""
+	for z in $zones; do
+		network_zone="$(uci -q get firewall.zone_${z}.network)"
+		if [ -z "$network_zone" ]; then
+			network_zone="$z"
+		fi
+		networks="$networks $network_zone"
+	done
+
+	sgw=$(uci -q get olsrd.@olsrd[0].SmartGateway)
+	for n in $networks; do
+		if [ "$sgw" = "yes" ]; then
+			del_rule olsr-tunnel $n
+		fi
+		del_rule olsr-default $n
+		if [ "$strict" != 0 ]; then
+			del_rule olsr-default_unreachable $n
+		fi
+	done
 	restart_services
 	echo "Hint: To completely disable freifunk-policyrouting set enable=0 in /etc/config/freifunk-policyrouting."
 }
 
 restart() {
 	logger -s -t policyrouting "Restarting policy routing"
-	olsrd_rmtables
-	del_lookup_rule olsr-default
-	del_lookup_rule olsr
-	del_lookup_rule localnets
-	uci commit network
 	start
 }
Index: openwrt/feeds/luci/contrib/package/freifunk-policyrouting/Makefile
===================================================================
--- openwrt.orig/feeds/luci/contrib/package/freifunk-policyrouting/Makefile
+++ openwrt/feeds/luci/contrib/package/freifunk-policyrouting/Makefile
@@ -4,7 +4,7 @@
 include $(TOPDIR)/rules.mk
 
 PKG_NAME:=freifunk-policyrouting
-PKG_RELEASE:=6
+PKG_RELEASE:=7
 
 PKG_BUILD_DIR := $(BUILD_DIR)/$(PKG_NAME)
 
